**虚拟内存**：将逻辑内存与物理内存分开

**稀地址空间**：包括空白的虚拟地址空间。有点事随着程序的执行，栈或堆栈的生长时可以填充这些空白



# 按需调页

**引入虚存后，换入换出不再以进程为单位，而是以页面为单位**，称为**lazy swapper**

交换程序称为**调页程序（pager）**

若要访问的页面不在内存，要进行判断

若地址越界，则abort

若地址有效，需要调入内存

（根据页表中的有效位）

页表中有效位若置为‘i‘，表示地址无效或有效，但是不在内存中

**缺页处理**

程序执行过程中，指令执行期间需要内存访问，地址转换时会有page fault，os查看internal table(与pcb保存在一起)，保存了进程的逻辑页有哪些，保存在什么位置

如果地址非法，abort

如果有效，把页调入到一个空闲的frame，更新页表，把该页的有效位置为有效

重新执行未执行完的指令 

**pure demand paging**：进程创建时不分配任何空间，只根据指令地址分配页

 ## 硬件支持

* 有有效位的页表
* 次级存储器用来保存不在内存中的页，通常为快速磁盘，被称为交换设备

![](.\chap9picture\QQ截图20211211171239.png)

## 按需调页性能

设缺页率p

![](.\chap9picture\QQ截图20211211171508.png)



![](.\chap9picture\QQ截图20211211171715.png)

一次I/O大约8ms，磁头移动5ms，磁盘旋转3ms，读取0.05

# 写时复制

允许父进程与子进程开始时共享同一页面，这些页面标记为写时复制页

如果任何一个进程需要对页修改，就创建一个副本

![](.\chap9picture\QQ截图20211212205123.png)

空闲缓冲池：空闲页

zero-fill-on-demand：按需填零，按需填零页再分配前先填零，清除了之前的内容

**vfork()**：虚存版本的fork()，会将父进程挂起，子进程使用父进程的地址空间，使用时要确保子进程不修改父进程的地址空间，通常用于子进程被创建后立即调用exec()的情况

**子进程结束必须调用exit(0)，**

# 页面置换

## basic page replacement

如果有空闲帧，直接分配即可，若没有空闲帧

* 使用置换算法选择一个victim frame
* 如果该帧被修改过，将其写回磁盘中，并修改页表和帧表
* 重启用户进程

处理页错误的时间加倍（换入，换出），页相应增加了有效访问时间

**可以通过使用modify bit 或dirty bit以降低额外开销**：每页或帧有一个修改位，通过硬件相关联。每当页内的任何字或字节被写入时，硬件就会设置该页的修改为以表示该页已修改

### 算法性能评价

人工生成一个refefence string(即内存的应用序列)，运行某个置换算法，并计算出页错误的数量

## FIFO

## OPT

## LRU

OPT和LRU都没有Belady异常，且同属一类算法，称为栈算法

**栈的实现方法：**

当页面被访问时，将其放入栈顶，这样栈底就是要被替换的页面

将frame做成双向链表的方法

## 近似LRU置换

在页面中增加一个访问位，将页面调入时将其置为0，被英勇时置为1

可以增加8bit的历史位，来记录访问，随时间增加，可以记录9个时间段，当要发生置换时，置换最小的历史位的页

### 二次机会算法

基于FIFO算法

需要访问位

当需要置换的页访问位为1时，将其置零，并从接下来的页扫描

![](.\chap9picture\QQ截图20211213110437.png)

### 增强型二次机会算法(Enhanced second-chance algorithm)

将引用位和修改位作为有序对考虑：

* (0,0)没有被使用也没有被修改，是最优的替换选择
* (0,1)最近没有使用过但是被修改过，在置换前需要写回
* (1,0)最近使用但没有修改，可能很快又要被使用
* (1,1)最不好的替换选择

当需要置换时，可使用时钟算法，检查所指页属于哪个类型，置换在最低飞控类中所碰到的页，可能要多次搜索循环队列

### 基于计数的页置换

为每个页保留一个用于记录引用次数的计数器

#### LFU（最不经常使用页）

置换计数最小的页

#### MFU（最常使用页置换）

置换计数最大的页

## 页缓冲算法(Page-buffering )



